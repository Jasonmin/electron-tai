<template class="task-template">
    <section id="appMenu-section" data-loaded=false class="section js-section u-category-default">

        <head>
            <meta charset="UTF-8">


            <script>

                var isRequesting = false

                var e = document.getElementById('appMenu-section')
                var observer = new MutationObserver(function (event) {
                    let isShown = e.classList[3]
                    if (isShown == 'is-shown' && e.dataset.loaded == "false") {
                        request_getAppMenus()
                    }
                })
                observer.observe(e, {
                    attributeFilter: ['class']
                })

                // request_getAppMenus()
                function request_getAppMenus() {

                    if (isRequesting) {
                        return
                    }

                    var url = `${globalConfig.serviceUrl}/AppApi/GetAppMenus`;
                    let userName = `taiji`

                    let token = getWebTokenWithUserName(userName);
                    
                    isRequesting = true
                    fetch(url, {
                        method: "POST",
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded'
                        },
                        body: `token=${token}&userName=${userName}`
                    })
                        .then(res => {
                            console.log(`menu res:${res.url}`)
                            res.json().then(function (obj) {
                                if (obj.code == 0) {
                                    var e = document.getElementById('appMenu-section')
                                    e.dataset.loaded = "true"

                                    var menus = obj.data;
                                    console.log(menus)

                                    let colCount = 4;
                                    let rowCount = menus.length / colCount;

                                    let grid = new Grid({
                                        container: document.getElementsByClassName('grid')[0],// 必须项
                                        colCount: colCount,
                                        rowCount: rowCount,
                                        width: 600,
                                        height: 150 * rowCount,
                                    });
                                    let grids = grid.getGrids();
                                    for (let i = 0; i < menus.length; i++) {
                                        let item = menus[i]
                                        let aGrid = grids[i]


                                        let br1 = document.createElement('br')
                                        aGrid.appendChild(br1)
                                        let br10 = document.createElement('br')
                                        aGrid.appendChild(br10)

                                        let img = document.createElement('img')
                                        img.src = item.icon
                                        img.width = 60
                                        img.height = 60
                                        aGrid.appendChild(img)

                                        let br2 = document.createElement('br')
                                        aGrid.appendChild(br2)

                                        let a = document.createElement('a');
                                        a.innerHTML = item.name
                                        a.href = `${item.url}?username=taiji`
                                        a.class = 'u-visible-to-screen-reader'
                                        aGrid.appendChild(a)
                                    }
                                    console.log(grid.getGrids());
                                }
                            })
                        })
                        .catch(error => {
                            alert('Error:', error)
                            console.log(error)
                        })
                }
            </script>
        </head>

        <h1>应用中心</h1>

        <body>

            <div class="grid container">
            </div>
            <div><br><br><br><br><br></div>
        </body>

    </section>

</template>